jQuery(document).ready(function($){

    /*========== Popup open if area set or not ============*/
    if(easyCooki.home == 'home' && easyCooki.setarea == 'set_false'){
        jQuery('div#easyshippingWrap').show();
    }else if(easyCooki.home == '' && easyCooki.setarea == 'set_false')
        window.location.href = easyCooki.homeurl;
    else{
        jQuery('div#easyshippingWrap').hide()
    }
    

	jQuery(".select2").select2();

	//=============== S E L E C T  C I T Y ================//
	jQuery(document.body).on('change', 'select[name="state"]', function(){
		jQuery(".delivery").block({message:null,overlayCSS:{background:"#fff",opacity:.6}});
		var selectCity = jQuery('select[name="city"]');
        var selectArea = jQuery('select[name="area"]');
		var output = '';
		var formData = {
			sID: 			jQuery(this).val(),
			cnt: 			jQuery(this).find(':selected').data('cntrycode'),
			action: 		'getAllCityviaState'
		};

		$.ajax({
            type : 'post',
            dataType: 'json',
            data : formData,
            url : easyAjax,
            success:function(data){
                console.log(data);
                if(data.message == 'success'){

                	if(easyCooki.v_city == 'yes'){
                        output+='<option value="">Select City...</option>';
                    	$.each(data.outputs, function(k,v){
                    		output+='<option value="'+v+'">'+v+'</option>';
                    	});
                    	selectCity.html(output);
                    }else{
                        output+='<option value="">Select Area...</option>';
                        $.each(data.outputs, function(k,v){
                            output+='<option value="'+v+'">'+v+'</option>';
                        });
                        selectArea.html(output);
                    }


                	jQuery(".delivery").unblock();
                }
            }
        });


	});


    //=============== G E T  A L L  A R E A  V I A  C I T Y ================//
    jQuery(document.body).on('change', 'select[name="city"]', function(){
        jQuery(".delivery").block({message:null,overlayCSS:{background:"#fff",opacity:.6}});
        var selectArea = jQuery('select[name="area"]');
        var cnt = jQuery(this).closest('form').find('select[name="state"]').find(':selected').data('cntrycode');
        if(typeof cnt == 'undefined') cnt = jQuery(this).find(':selected').data('cnt');
        var output = '';
        console.log('cnt: ' + cnt);
        var formData = {
            sID:            jQuery('select[name="state"]').val(),
            city_name:      jQuery(this).val(),
            cnt:            cnt,
            action:         'getAllArea'
        };
        if(jQuery(this).val() !== ''){
            $.ajax({
                type : 'post',
                dataType: 'json',
                data : formData,
                url : easyAjax,
                success:function(data){
                    console.log(data);
                    if(data.message == 'success'){
                        output+='<option value="">Select Delivery Area...</option>';
                        $.each(data.area, function(k,v){
                            output+='<option value="'+v+'">'+v+'</option>';
                        });
                        selectArea.html(output);
                        jQuery(".delivery").unblock();
                    }
                }
            });
        }else{
            jQuery(".delivery").unblock();
        }
    });



    //========================== C H A N G E  C O U N T R Y ========================//
    jQuery(document.body).on('change', 'select[name="country"]', function(){
        jQuery(".delivery").block({message:null,overlayCSS:{background:"#fff",opacity:.6}});
        var cityarea = jQuery('select[name="city"]');
        var selectArea = jQuery('select[name="area"]');
        var statearea = jQuery('select[name="state"]');
        var output = '';
        var thisValue = jQuery(this).val();
        var formData = {
            country: thisValue,
            action: 'getDatausingCountry'
        };
        if(jQuery(this).val() !== ''){
            $.ajax({
                type : 'post',
                dataType: 'json',
                data : formData,
                url : easyAjax,
                success:function(data){
                    console.log(data);
                    if(data.message == 'success'){
                        if(easyCooki.v_state == 'yes'){
                            output+='<option value="">Select State...</option>';    
                            $.each(data.output, function(k,v){
                                output+='<option data-cntrycode="'+thisValue+'" value="'+k+'">'+v+'</option>';
                            });
                            statearea.html(output);
                        }else if(easyCooki.v_city == 'yes'){
                            output+='<option value="">Select City...</option>';    
                            $.each(data.output, function(k,v){
                                output+='<option data-cnt="'+thisValue+'" value="'+v+'">'+v+'</option>';
                            });
                            cityarea.html(output);
                        }else{
                            output+='<option value="">Select Area...</option>';    
                            $.each(data.output, function(k,v){
                                output+='<option value="'+v+'">'+v+'</option>';
                            });
                            selectArea.html(output);
                        }

                        jQuery(".delivery").unblock();
                    }
                }
            });
        }else{
            jQuery(".delivery").unblock();
        }

    });


    //======================== S E T  L O C A T I O N  I N  C O O K I E =======================//
    jQuery(document.body).on('click', 'input#easy_locationSave', function(e){
        e.preventDefault();
        jQuery(".delivery").block({message:null,overlayCSS:{background:"#fff",opacity:.6}});

        if(easyCooki.v_popup2 == 'yes'){
            var country = jQuery(this).closest('form').find('select[name="state"]').find(':selected').data('cntrycode');
            var state = jQuery(this).closest('form').find('select[name="state"]').val();
            var city = jQuery(this).closest('form').find('select[name="city"]').val();
            var area = jQuery(this).closest('form').find('select[name="area"]').val();
            
            country     = (typeof country != 'undefined')?country:jQuery(this).closest('form').find('select[name="country"]').find('option').attr('value');
            state       = (typeof state != 'undefined')?state:'';
            city        = (typeof city != 'undefined')?city:'';
            area        = (typeof area != 'undefined')?area:'';

            var formData = {
                country: country,
                state: state,
                city:city,
                area:area,
                action:'popupaction2'
            }
            $.ajax({
                type : 'post',
                dataType: 'json',
                data : formData,
                url : easyAjax,
                success:function(data){
                    //console.log(data);
                    if(data.message = 'success'){
                            display('easy_country', data.qry.country_name);
                            display('easy_state', data.qry.state);
                            display('easy_city', data.qry.city);
                            display('easy_area', data.qry.delivery_area);
                            jQuery('#easyshippingWrap').slideUp();
                            window.location.reload();
                    }
                }
            });
        }else{
            var formVal = jQuery('input[name="typeDeliveryArea"]').val();
            var fformData = {
                val: formVal, 
                action: 'popuptAction'
            }
             $.ajax({
                type : 'post',
                dataType: 'json',
                data : fformData,
                url : easyAjax,
                success:function(data){
                    //console.log(data);
                    if(data.message == 'success'){
                            display('easy_country', data.qry.country_name);
                            display('easy_state', data.qry.state);
                            display('easy_city', data.qry.city);
                            display('easy_area', data.qry.delivery_area);
                            jQuery(".delivery").unblock();
                            jQuery('#easyshippingWrap').slideUp();
                            window.location.reload();
                    }
                }
            });
        }
        
    });


    /** =============== Reset Deliver Location ================*/
    jQuery(document.body).on('click', 'div#deliverAreaReset', function(){
        deleteCooki('easy_country');
        deleteCooki('easy_state');
        deleteCooki('easy_city');
        deleteCooki('easy_area');
        window.location.href = easyCooki.homeurl;
    });


    /*** =============== Enable ok button ================ **/
    jQuery(document.body).on('change', 'select[name="state"], select[name="city"], select[name="area"]', function(){
        var city = jQuery('select[name="city"]').val();
        var state = jQuery('select[name="state"]').val();
        var area = jQuery('select[name="area"]').val();
        if(city !== '' && state !== '' && area !== ''){
            $('input#easy_locationSave').prop('disabled', false);
        }else{
            $('input#easy_locationSave').prop('disabled', true);
        }
    }); // End change select[name="state"], select[name="city"], select[name="area"]




    /*================== IF Single value in state / country ===================*/
    if(jQuery('select[name="country"]').is(':disabled') && easyCooki.v_state == 'no' || jQuery('select[name="state"]').is(':disabled')){
        var state = jQuery('select[name="state"]').val(),
        country =  jQuery('select[name="state"]').find(':selected').data('cntrycode');
        if(typeof country == 'undefined') country = jQuery('select[name="country"]').val();

        var selectCity = jQuery('select[name="city"]');
        var selectArea = jQuery('select[name="area"]');
        var output = '';
        var deliveryArea = '';
        var formData = {
            sID:            state,
            cnt:            country,
            action:         'getAllCityviaState'
        };

        $.ajax({
            type : 'post',
            dataType: 'json',
            data : formData,
            url : easyAjax,
            success:function(data){
                if(data.message == 'success'){
                    if(easyCooki.v_city == 'yes'){
                        if((data.outputs).length > 1) output+='<option value="">Select City...</option>';
                        if((data.outputs).length <= 1){
                            selectCity.prop('disabled', true);
                                
                                var fformData = {
                                        sID:            state,
                                        city_name:      data.outputs[0],
                                        cnt:            country,
                                        action:         'getAllArea'
                                };
                                $.ajax({
                                            type : 'post',
                                            dataType: 'json',
                                            data : fformData,
                                            url : easyAjax,
                                            success:function(data1){
                                                //console.log(data1);
                                                if(data1.message == 'success'){
                                                    deliveryArea+=((data1.area).length >1)?'<option value="">Select Delivery Area...</option>':'';
                                                    if((data1.area).length <=1) $('input#easy_locationSave').prop('disabled', false);
                                                    $.each(data1.area, function(n,m){
                                                        deliveryArea+='<option value="'+m+'">'+m+'</option>';
                                                    });
                                                    selectArea.html(deliveryArea);
                                                }
                                            }
                                });
                        } 
                        
                        $.each(data.outputs, function(k,v){
                            selected = (v == easyCooki.permalinkcity)?'selected':'';
                            output+='<option '+selected+' value="'+v+'">'+v+'</option>';
                        });
                        selectCity.html(output);
                    }else{
                        output+='<option value="">Select Area...</option>';
                        $.each(data.outputs, function(k,v){
                            output+='<option value="'+v+'">'+v+'</option>';
                        });
                        selectArea.html(output);
                    }
                    jQuery(".delivery").unblock();
                }
            }
        });
    } // end if single value 



    

    /*
    * Popup style type typebox and autofill 
    */
    function log( message ) {
      $( "<div>" ).text( message ).prependTo( "#log" );
      $( "#log" ).scrollTop( 0 );
    }

     jQuery( "#typeDeliveryArea" ).autocomplete({

      source: function( request, response ) {

        $.ajax( {
          url: easyAjax,
          dataType: "json",
          type : 'post',
          data: {
            term: request.term,
            action: 'typeDeliveryAutoFill'
          },
          success: function( data ) {
            //console.log(data);
            response( data );
          }
        });
      },
      minLength: 2,
      select: function( event, ui ) {
        log( "Selected: " + ui.item.value + " aka " + ui.item.id );
        $('input#easy_locationSave').prop('disabled', false);
      }
    });
}); // End document Ready


/* JavaScript Function */
function display(cookiename, value) { 
  var now = new Date();
  var time = now.getTime();
  var expireTime = time + 1000*3600;
  now.setTime(expireTime);
  document.cookie = cookiename+'='+value+';expires='+now.toGMTString()+';path=/';
}

function deleteCooki(cookiename) { 
  var now = new Date();
  var time = now.getTime();
  var value = '';
  var expireTime = time - 1000*3600;
  now.setTime(expireTime);
  document.cookie = cookiename+'='+value+';expires='+now.toGMTString()+';path=/';
}


// Delete Cookie
function del_cookie(name) {
   document.cookie = name + '=; expires=Thu, 01-Jan-70 00:00:01 GMT;';
} 